<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üéì Student Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-8">

  <h1 class="text-3xl font-bold text-gray-800 mb-8">üéì Student Management</h1>

  <!-- CREATE BUTTON + SEARCH BAR + FILTERS -->
  <div class="w-full max-w-6xl flex flex-wrap justify-between items-center mb-4 gap-3">
    <div class="flex gap-3 w-full md:w-auto">
      <button onclick="openCreateModal()" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
        ‚ûï Add Student
      </button>
    </div>

    <div class="flex flex-wrap gap-3 justify-end items-center w-full md:w-auto">
      <input type="text" id="searchInput" placeholder="üîç Search name, email, or program..." class="p-2 border rounded w-64" onkeyup="applyFilters()">

      <select id="filterProgram" class="p-2 border rounded" onchange="applyFilters()">
        <option value="">All Programs</option>
        {% for p in programs %}
          <option value="{{ p.program_name }}">{{ p.program_name }}</option>
        {% endfor %}
      </select>

      <select id="filterActive" class="p-2 border rounded" onchange="applyFilters()">
        <option value="">All</option>
        <option value="true">Active</option>
        <option value="false">Inactive</option>
      </select>
    </div>
  </div>

  <!-- Spinner -->
  <div id="loadingSpinner" class="hidden flex justify-center items-center mt-10">
    <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
  </div>

  <!-- STUDENT TABLE -->
  <div id="tableContainer" class="overflow-x-auto w-full max-w-6xl bg-white shadow-lg rounded-lg border border-gray-200">
    <table id="studentsTable" class="min-w-full text-sm text-left text-gray-700">
      <thead class="bg-blue-100 text-gray-800 uppercase">
        <tr>
          <th class="px-4 py-3 cursor-pointer" onclick="sortTable('id')">ID</th>
          <th class="px-4 py-3 cursor-pointer" onclick="sortTable('first_name')">First Name</th>
          <th class="px-4 py-3 cursor-pointer" onclick="sortTable('last_name')">Last Name</th>
          <th class="px-4 py-3 cursor-pointer" onclick="sortTable('email')">Email</th>
          <th class="px-4 py-3 cursor-pointer" onclick="sortTable('program_name')">Program</th>
          <th class="px-4 py-3 cursor-pointer" onclick="sortTable('active')">Active</th>
          <th class="px-4 py-3 text-center">Actions</th>
        </tr>
      </thead>
      <tbody id="studentsBody"></tbody>
    </table>
  </div>

  <!-- PAGINATION -->
  <div class="mt-4 flex justify-center gap-3" id="pagination"></div>

  <!-- CREATE MODAL -->
  <div id="createModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-lg">
      <h2 class="text-xl font-semibold mb-4">Add New Student</h2>
      <form id="createForm" onsubmit="createStudent(event)">
        <div class="grid grid-cols-2 gap-3">
          <input name="first_name" placeholder="First Name" class="p-2 border rounded" required>
          <input name="last_name" placeholder="Last Name" class="p-2 border rounded" required>
          <input name="middle_name" placeholder="Middle Name" class="p-2 border rounded">
          <input name="email" type="email" placeholder="Email" class="p-2 border rounded" required>
          <input name="birth_date" type="date" class="p-2 border rounded">
          <select name="program_id" class="p-2 border rounded" required>
            <option value="">Select Program</option>
            {% for p in programs %}
              <option value="{{ p._id }}">{{ p.program_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="flex justify-end mt-5 gap-2">
          <button type="button" onclick="closeCreateModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Create</button>
        </div>
      </form>
    </div>
  </div>

  <!-- EDIT MODAL -->
  <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-lg">
      <h2 class="text-xl font-semibold mb-4">Edit Student</h2>
      <form id="editForm" onsubmit="updateStudent(event)">
        <input type="hidden" id="edit_id">
        <div class="grid grid-cols-2 gap-3">
          <input id="edit_first_name" name="first_name" placeholder="First Name" class="p-2 border rounded" required>
          <input id="edit_last_name" name="last_name" placeholder="Last Name" class="p-2 border rounded" required>
          <input id="edit_middle_name" name="middle_name" placeholder="Middle Name" class="p-2 border rounded">
          <input id="edit_email" name="email" type="email" placeholder="Email" class="p-2 border rounded" required>
          <input id="edit_birth_date" name="birth_date" type="date" class="p-2 border rounded">
          <select id="edit_program_id" class="p-2 border rounded" required>
            <option value="">Select Program</option>
            {% for p in programs %}
              <option value="{{ p._id }}">{{ p.program_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="flex justify-end mt-5 gap-2">
          <button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Update</button>
        </div>
      </form>
    </div>
  </div>

<script>
let students = {{ students | tojson }};
let currentPage = 1;
const rowsPerPage = 10;
let currentSort = { key: null, asc: true };
let unsavedChanges = false;

function showSpinner(show) {
  document.getElementById("loadingSpinner").classList.toggle("hidden", !show);
  document.getElementById("tableContainer").classList.toggle("hidden", show);
}

async function fetchStudents() {
  showSpinner(true);
  const res = await fetch("/students");
  students = await res.json();
  showSpinner(false);
  renderTable();
}

function renderTable() {
  const tbody = document.getElementById("studentsBody");
  tbody.innerHTML = "";
  const filtered = getFilteredStudents();
  const start = (currentPage - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const pageData = filtered.slice(start, end);

  for (const s of pageData) {
    tbody.innerHTML += `
      <tr id="row-${s._id}" class="border-b hover:bg-gray-50">
        <td class="px-4 py-2 font-mono text-xs">${s._id}</td>
        <td class="px-4 py-2">${s.first_name}</td>
        <td class="px-4 py-2">${s.last_name}</td>
        <td class="px-4 py-2">${s.email}</td>
        <td class="px-4 py-2">${s.program_name || '-'}</td>
        <td class="px-4 py-2">${s.active ? 'Yes' : 'No'}</td>
        <td class="px-4 py-2 text-center">
          <button onclick="openEditModal('${s._id}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs">
            ‚úèÔ∏è Edit
          </button>
          <button onclick="deleteStudent('${s._id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs">
            üóëÔ∏è Delete
          </button>
        </td>
      </tr>`;
  }
  renderPagination(filtered.length);
}

function renderPagination(total) {
  const pages = Math.ceil(total / rowsPerPage);
  const container = document.getElementById("pagination");
  container.innerHTML = "";
  for (let i = 1; i <= pages; i++) {
    container.innerHTML += `<button onclick="gotoPage(${i})" class="px-3 py-1 rounded ${i===currentPage ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300'}">${i}</button>`;
  }
}

function gotoPage(page) { currentPage = page; renderTable(); }
function applyFilters() { currentPage = 1; renderTable(); }
function getFilteredStudents() {
  const search = document.getElementById("searchInput").value.toLowerCase();
  const program = document.getElementById("filterProgram").value;
  const active = document.getElementById("filterActive").value;
  let result = students.filter(s =>
    (s.first_name.toLowerCase().includes(search) ||
     s.last_name.toLowerCase().includes(search) ||
     s.email.toLowerCase().includes(search) ||
     (s.program_name || '').toLowerCase().includes(search))
  );
  if (program) result = result.filter(s => s.program_name === program);
  if (active) result = result.filter(s => s.active.toString() === active);
  if (currentSort.key) {
    result.sort((a, b) => {
      const valA = (a[currentSort.key] || '').toString().toLowerCase();
      const valB = (b[currentSort.key] || '').toString().toLowerCase();
      return currentSort.asc ? valA.localeCompare(valB) : valB.localeCompare(valA);
    });
  }
  return result;
}
function sortTable(key) {
  if (currentSort.key === key) currentSort.asc = !currentSort.asc;
  else { currentSort.key = key; currentSort.asc = true; }
  renderTable();
}

// ‚úÖ Modal Handlers
function openCreateModal() { document.getElementById('createModal').classList.remove('hidden'); }
function closeCreateModal() {
  if (unsavedChanges && !confirm("You have unsaved changes. Close anyway?")) return;
  document.getElementById('createModal').classList.add('hidden');
  document.getElementById('createForm').reset();
  unsavedChanges = false;
}
function openEditModal(id) {
  const s = students.find(x => x._id === id);
  if (!s) return;
  document.getElementById('edit_id').value = s._id;
  document.getElementById('edit_first_name').value = s.first_name;
  document.getElementById('edit_last_name').value = s.last_name;
  document.getElementById('edit_middle_name').value = s.middle_name || '';
  document.getElementById('edit_email').value = s.email;
  document.getElementById('edit_birth_date').value = s.birth_date || '';
  document.getElementById('edit_program_id').value = s.program_id || '';
  document.getElementById('editModal').classList.remove('hidden');
}
function closeEditModal() {
  if (unsavedChanges && !confirm("You have unsaved changes. Close anyway?")) return;
  document.getElementById('editModal').classList.add('hidden');
  unsavedChanges = false;
}

// ‚úÖ CRUD
async function createStudent(e) {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target));
  const res = await fetch('/students', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
  if (res.ok) {
    closeCreateModal();
    await fetchStudents();
  } else alert('Failed to create student');
}

async function updateStudent(e) {
  e.preventDefault();
  const id = document.getElementById('edit_id').value;
  const data = {
    first_name: document.getElementById('edit_first_name').value,
    last_name: document.getElementById('edit_last_name').value,
    middle_name: document.getElementById('edit_middle_name').value,
    email: document.getElementById('edit_email').value,
    birth_date: document.getElementById('edit_birth_date').value,
    program_id: document.getElementById('edit_program_id').value
  };
  const res = await fetch(`/student/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
  if (res.ok) {
    closeEditModal();
    await fetchStudents();
  } else alert('Update failed');
}

async function deleteStudent(id) {
  if (!confirm('Are you sure you want to delete this student?')) return;
  const res = await fetch(`/student/${id}`, { method: 'DELETE' });
  if (res.ok) await fetchStudents();
  else alert('Delete failed');
}

fetchStudents();
</script>
</body>
</html>
